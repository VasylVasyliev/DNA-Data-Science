import numpy as np
import matplotlib.pyplot as plt
import os

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—à–∏—Ö —Ä–∞—Å—á–µ—Ç–æ–≤ 2026 –≥–æ–¥–∞) ---
BASE_TES = 66.37  # –ù–∞—à —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–ª –¥–ª—è Smart Pt
TOTAL_CELLS = 1000
RECEPTORS_PER_CELL = 100
CRITICAL_THRESHOLD = 30  # –ü–æ—Ä–æ–≥ –≤—ã–∂–∏–≤–∞–Ω–∏—è: –µ—Å–ª–∏ < 30 —Ä–µ—Ü–µ–ø—Ç–æ—Ä–æ–≤ –∞–∫—Ç–∏–≤–Ω—ã, –∫–ª–µ—Ç–∫–∞ –≥–∏–±–Ω–µ—Ç

def get_survival_at_dose(dose_multiplier):
    """
    –ú–æ–¥–µ–ª–∏—Ä—É–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–∂–∏–≤—à–∏—Ö –∫–ª–µ—Ç–æ–∫ HeLa –ø—Ä–∏ –∑–∞–¥–∞–Ω–Ω–æ–π –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏.
    """
    # –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ä–∞—Å—Ç–µ—Ç —Å –¥–æ–∑–æ–π
    eff = (BASE_TES * dose_multiplier) / 100
    if eff > 0.99: eff = 0.99
    
    # –°–∏–º—É–ª—è—Ü–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π –∏–∑ 1000 –∫–ª–µ—Ç–æ–∫: —Å–∫–æ–ª—å–∫–æ —Ä–µ—Ü–µ–ø—Ç–æ—Ä–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å —Å–≤–æ–±–æ–¥–Ω—ã–º–∏
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∏–Ω–æ–º–∏–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (n=100 –ø–æ–ø—ã—Ç–æ–∫, p=–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Å–ø–µ—Ö–∞ 1-eff)
    surviving_receptors = np.random.binomial(RECEPTORS_PER_CELL, 1 - eff, TOTAL_CELLS)
    
    # –ö–ª–µ—Ç–∫–∞ –∂–∏–≤–∞, –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Ä–µ—Ü–µ–ø—Ç–æ—Ä–æ–≤ –≤—ã—à–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ—Ä–æ–≥–∞
    alive_count = np.sum(surviving_receptors > CRITICAL_THRESHOLD)
    return alive_count

# --- –ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ ---
# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –¥–æ–∑: –æ—Ç 0.5x –¥–æ 3.0x —Å —à–∞–≥–æ–º 0.1
doses = np.arange(0.5, 3.1, 0.1)
survival_stats = [get_survival_at_dose(d) for d in doses]

# --- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ ---
plt.figure(figsize=(10, 6))
plt.plot(doses, survival_stats, 'o-', color='#32CD32', lw=2, markersize=5, label='–í—ã–∂–∏–≤—à–∏–µ –∫–ª–µ—Ç–∫–∏ HeLa')

# –î–æ–±–∞–≤–ª—è–µ–º –∫—Ä–∞—Å–Ω—É—é –ª–∏–Ω–∏—é LD50 (50% —Å–º–µ—Ä—Ç–Ω–æ—Å—Ç–∏ = 500 –≤—ã–∂–∏–≤—à–∏—Ö –∫–ª–µ—Ç–æ–∫)
plt.axhline(500, color='red', linestyle='--', alpha=0.8, label='–ü–æ—Ä–æ–≥ LD50 (500 –∫–ª–µ—Ç–æ–∫)')

# –ü–æ–∏—Å–∫ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ—á–∫–∏ LD50
try:
    # –ò—â–µ–º –ø–µ—Ä–≤—É—é –¥–æ–∑—É, –≥–¥–µ –≤—ã–∂–∏–≤–∞–µ–º–æ—Å—Ç—å —É–ø–∞–ª–∞ –Ω–∏–∂–µ 500
    idx = np.where(np.array(survival_stats) < 500)[0][0]
    ld50_val = doses[idx]
    plt.axvline(ld50_val, color='blue', linestyle=':', alpha=0.6)
    plt.text(ld50_val + 0.05, 550, f'LD50 ‚âà {ld50_val:.2f}x', color='blue', fontweight='bold')
except IndexError:
    ld50_val = "–ù–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ –≤ —ç—Ç–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
plt.title("–ö—Ä–∏–≤–∞—è Dose-Response: Smart Platinum vs HeLa (Bioinformatics 2026)", fontsize=12)
plt.xlabel("–ú–Ω–æ–∂–∏—Ç–µ–ª—å –¥–æ–∑—ã (–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è)", fontsize=10)
plt.ylabel("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∂–∏–≤—ã—Ö –∫–ª–µ—Ç–æ–∫ (–∏–∑ 1000)", fontsize=10)
plt.grid(True, alpha=0.3)
plt.legend()

# --- –ë–ª–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞ ---
# –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ –æ—Ç—á–µ—Ç–æ–≤
save_dir = "Project_HeLa_Research/reports"
save_path = os.path.join(save_dir, "dose_response_curve.png")

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
os.makedirs(save_dir, exist_ok=True)

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –≤—ã–≤–æ–¥–∏–º
plt.savefig(save_path, dpi=300)
print(f"\n" + "="*50)
print(f"üìä –ì—Ä–∞—Ñ–∏–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–æ–∑–∞-—ç—Ñ—Ñ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {save_path}")
print(f"üß¨ –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å LD50: {ld50_val}")
print("="*50)

plt.show()